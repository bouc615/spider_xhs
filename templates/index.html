<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•°æ®é‡‡é›†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
      background: #ffffff;
      min-height: 100vh;
      padding: 60px 20px;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .auth-section {
      margin-bottom: 40px;
      padding: 20px;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      background: #fafafa;
    }

    .auth-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      font-size: 18px;
    }

    .status-indicator.valid {
      color: #4caf50;
    }

    .status-indicator.invalid {
      color: #f44336;
    }

    .status-indicator.unknown {
      color: #ff9800;
    }

    .config-btn {
      margin-left: auto;
      padding: 6px 12px;
      background: none;
      border: 1px solid #e5e5e5;
      color: #666;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .config-btn:hover {
      border-color: #333;
      color: #333;
    }

    .auth-config {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e5e5;
    }

    .auth-help {
      margin-top: 8px;
    }

    .auth-help details {
      font-size: 13px;
      color: #666;
    }

    .auth-help summary {
      cursor: pointer;
      color: #4285f4;
    }

    .auth-help ol {
      margin: 8px 0 0 20px;
    }

    .auth-help li {
      margin-bottom: 4px;
    }

    .auth-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .save-btn,
    .test-btn,
    .clear-btn {
      padding: 8px 16px;
      border: 1px solid #e5e5e5;
      background: white;
      color: #666;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .save-btn:hover {
      border-color: #4caf50;
      color: #4caf50;
    }

    .test-btn:hover {
      border-color: #2196f3;
      color: #2196f3;
    }

    .clear-btn:hover {
      border-color: #f44336;
      color: #f44336;
    }

    .form-section {
      margin-bottom: 60px;
    }

    .form-group {
      margin-bottom: 32px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 400;
      color: #666;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 16px 0;
      border: none;
      border-bottom: 1px solid #e5e5e5;
      font-size: 16px;
      background: transparent;
      transition: border-color 0.2s ease;
      font-family: inherit;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-bottom-color: #333;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: #ccc;
    }

    .search-btn {
      width: 100%;
      padding: 16px;
      background: #333;
      color: white;
      border: none;
      font-size: 16px;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 24px;
    }

    .search-btn:hover {
      background: #000;
    }

    .search-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .progress-section {
      display: none;
      margin-bottom: 40px;
    }

    .progress-bar {
      width: 100%;
      height: 2px;
      background: #f0f0f0;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #333;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      color: #666;
      font-size: 14px;
    }

    .tasks-section {
      border-top: 1px solid #f0f0f0;
      padding-top: 40px;
    }

    .tasks-title {
      font-size: 16px;
      margin-bottom: 24px;
      color: #666;
      font-weight: 400;
    }

    .task-item {
      padding: 20px 0;
      border-bottom: 1px solid #f8f8f8;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-info h3 {
      color: #333;
      margin-bottom: 4px;
      font-size: 16px;
      font-weight: 400;
    }

    .task-info p {
      color: #999;
      font-size: 13px;
    }

    .task-status {
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 400;
      border-radius: 12px;
    }

    .status-completed {
      background: #f0f8f0;
      color: #4a7c59;
    }

    .status-running {
      background: #fff8e1;
      color: #8a6914;
    }

    .status-failed {
      background: #fdf2f2;
      color: #a94442;
    }

    .view-btn {
      background: none;
      color: #666;
      border: 1px solid #e5e5e5;
      padding: 6px 16px;
      cursor: pointer;
      text-decoration: none;
      font-size: 13px;
      margin-left: 12px;
      transition: all 0.2s ease;
    }

    .view-btn:hover {
      color: #333;
      border-color: #333;
    }

    .empty-state {
      text-align: center;
      color: #ccc;
      font-size: 14px;
      padding: 40px 0;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #4caf50;
    }

    .notification.error {
      background: #f44336;
    }

    .notification.info {
      background: #2196f3;
    }

    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 768px) {
      body {
        padding: 20px 15px;
      }

      .container {
        max-width: 100%;
      }

      .auth-help details {
        font-size: 12px;
      }

      .auth-help ol {
        margin-left: 15px;
      }

      .auth-help li {
        margin-bottom: 6px;
      }

      .method-section {
        margin-bottom: 15px;
      }

      .form-group input,
      .form-group textarea {
        font-size: 16px;
        /* é˜²æ­¢iOSç¼©æ”¾ */
      }

      .auth-actions {
        flex-direction: column;
        gap: 8px;
      }

      .save-btn,
      .test-btn,
      .clear-btn {
        width: 100%;
        padding: 12px 16px;
      }

      .search-btn {
        padding: 18px;
        font-size: 16px;
      }

      .notification {
        right: 10px;
        left: 10px;
        transform: translateY(-100px);
      }

      .notification.show {
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="auth-section">
      <div class="auth-status">
        <span class="status-indicator unknown" id="statusIndicator">âš ï¸</span>
        <span id="statusText">ç™»å½•å‡­è¯æœªé…ç½®</span>
        <button type="button" class="config-btn" onclick="toggleAuthConfig()">
          é…ç½®
        </button>
      </div>

      <div class="auth-config" id="authConfig" style="display: none">
        <div class="form-group">
          <label for="authInput">å°çº¢ä¹¦ç™»å½•å‡­è¯</label>
          <textarea id="authInput" placeholder="è¯·ç²˜è´´å°çº¢ä¹¦ç™»å½•åçš„èº«ä»½éªŒè¯ä¿¡æ¯..." rows="4"></textarea>
          <div class="auth-help">
            <details>
              <summary>å¦‚ä½•è·å–ç™»å½•å‡­è¯ï¼Ÿ</summary>
              <ol style="margin: 12px 0 0 20px">
                <li>æ‰“å¼€å°çº¢ä¹¦ç½‘é¡µç‰ˆ (xiaohongshu.com) å¹¶å®Œæˆç™»å½•</li>
                <li>æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
                <li>åˆ‡æ¢åˆ°Network(ç½‘ç»œ)æ ‡ç­¾</li>
                <li>åˆ·æ–°é¡µé¢ï¼Œåœ¨è¯·æ±‚åˆ—è¡¨ä¸­æ‰¾åˆ°ä»»æ„è¯·æ±‚</li>
                <li>ç‚¹å‡»è¯·æ±‚ï¼Œåœ¨Request Headersä¸­æ‰¾åˆ°Cookieå­—æ®µ</li>
                <li>å¤åˆ¶å®Œæ•´çš„Cookieå€¼å¹¶ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
              </ol>

              <div style="
                    background: #f8f9fa;
                    padding: 12px;
                    border-radius: 4px;
                    margin-top: 16px;
                  ">
                <strong style="color: #e67e22">ğŸ“± ç§»åŠ¨ç«¯ç”¨æˆ·</strong>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #666">
                  å»ºè®®æ‰¾ä¸€å°ç”µè„‘è·å–ç™»å½•å‡­è¯ï¼Œç„¶åé€šè¿‡QQã€å¾®ä¿¡ç­‰å‘é€ç»™è‡ªå·±ï¼Œåœ¨æ‰‹æœºä¸Šå¤åˆ¶ç²˜è´´å³å¯
                </p>
              </div>

              <p style="margin-top: 12px; font-size: 12px; color: #999">
                ğŸ’¡ æç¤ºï¼šç™»å½•å‡­è¯é€šå¸¸æœ‰æ•ˆæœŸä¸º7-30å¤©ï¼Œå¤±æ•ˆåéœ€è¦é‡æ–°è·å–
              </p>
            </details>
          </div>
        </div>
        <div class="auth-actions">
          <button type="button" class="save-btn" onclick="saveAuth()">
            ä¿å­˜ç™»å½•å‡­è¯
          </button>
          <button type="button" class="test-btn" onclick="testAuth()">
            æµ‹è¯•ç™»å½•å‡­è¯
          </button>
          <button type="button" class="clear-btn" onclick="clearAuth()">
            æ¸…é™¤ç™»å½•å‡­è¯
          </button>
        </div>
      </div>
    </div>

    <div class="form-section">
      <form id="searchForm">
        <div class="form-group">
          <label for="keyword">å…³é”®è¯</label>
          <input type="text" id="keyword" name="keyword" placeholder="è¾“å…¥æœç´¢å…³é”®è¯" required />
        </div>

        <div class="form-group">
          <label for="numNotes">æ•°é‡</label>
          <input type="number" id="numNotes" name="numNotes" min="1" max="100" value="10" required />
        </div>

        <button type="submit" class="search-btn" id="searchBtn">
          å¼€å§‹é‡‡é›†
        </button>
      </form>

      <div class="progress-section" id="progressSection">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
      </div>
    </div>

    <div class="tasks-section" id="tasksSection" style="display: none">
      <div class="tasks-title">å†å²è®°å½•</div>
      <div id="tasksList">
        <div class="empty-state">æš‚æ— è®°å½•</div>
      </div>

      <div style="
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
          ">
        <a href="/test_image" target="_blank" style="color: #666; text-decoration: none; font-size: 13px">ğŸ”§ å›¾ç‰‡ä»£ç†æµ‹è¯•</a>
      </div>
    </div>
  </div>

  <script>
    let currentTaskId = null;
    let progressInterval = null;

    document.addEventListener("DOMContentLoaded", function () {
      // æ£€æŸ¥URLå‚æ•°ï¼Œåªæœ‰ history=1 æ—¶æ‰æ˜¾ç¤ºå†å²è®°å½•
      const urlParams = new URLSearchParams(window.location.search);
      const showHistory = urlParams.get('history') === '1';

      if (showHistory) {
        document.getElementById('tasksSection').style.display = 'block';
        loadTasks();
      }

      checkAuthStatus();
    });

    document
      .getElementById("searchForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const keyword = document.getElementById("keyword").value.trim();
        const numNotes = parseInt(document.getElementById("numNotes").value);

        if (!keyword) {
          showNotification("è¯·è¾“å…¥æœç´¢å…³é”®è¯", "error");
          return;
        }

        // æ£€æŸ¥ç™»å½•å‡­è¯
        const cookie = localStorage.getItem("xhs_cookie");
        if (!cookie) {
          showNotification("è¯·å…ˆé…ç½®ç™»å½•å‡­è¯", "error");
          toggleAuthConfig();
          return;
        }

        startSearch(keyword, numNotes);
      });

    // ç™»å½•å‡­è¯ç®¡ç†åŠŸèƒ½
    function toggleAuthConfig() {
      const config = document.getElementById("authConfig");
      const isVisible = config.style.display !== "none";
      config.style.display = isVisible ? "none" : "block";

      if (!isVisible) {
        // æ˜¾ç¤ºæ—¶åŠ è½½å·²ä¿å­˜çš„ç™»å½•å‡­è¯
        const savedAuth = localStorage.getItem("xhs_cookie");
        if (savedAuth) {
          document.getElementById("authInput").value = savedAuth;
        }
      }
    }

    function saveAuth() {
      const authInput = document.getElementById("authInput");
      const auth = authInput.value.trim();

      if (!auth) {
        showNotification("è¯·è¾“å…¥ç™»å½•å‡­è¯", "error");
        return;
      }

      // åŸºæœ¬æ ¼å¼éªŒè¯
      if (!auth.includes("=") || auth.length < 50) {
        showNotification(
          "ç™»å½•å‡­è¯æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿å¤åˆ¶å®Œæ•´çš„èº«ä»½éªŒè¯ä¿¡æ¯",
          "error"
        );
        return;
      }

      // æ£€æŸ¥å¿…è¦å­—æ®µ
      const requiredFields = ["a1", "web_session"];
      const missingFields = requiredFields.filter(
        (field) => !auth.includes(`${field}=`)
      );

      if (missingFields.length > 0) {
        showNotification(
          `ç™»å½•å‡­è¯ç¼ºå°‘å¿…è¦å­—æ®µ: ${missingFields.join(
            ", "
          )}ï¼Œè¯·ç¡®ä¿å·²ç™»å½•å°çº¢ä¹¦åå¤åˆ¶å®Œæ•´ä¿¡æ¯`,
          "error"
        );
        return;
      }

      localStorage.setItem("xhs_cookie", auth);
      showNotification("ç™»å½•å‡­è¯ä¿å­˜æˆåŠŸï¼Œå»ºè®®ç‚¹å‡»æµ‹è¯•éªŒè¯", "success");
      checkAuthStatus();
    }

    function testAuth() {
      const auth =
        document.getElementById("authInput").value.trim() ||
        localStorage.getItem("xhs_cookie");

      if (!auth) {
        showNotification("è¯·å…ˆè¾“å…¥ç™»å½•å‡­è¯", "error");
        return;
      }

      // å‘é€æµ‹è¯•è¯·æ±‚
      fetch("/api/test_cookie", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ cookie: auth }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showNotification("ç™»å½•å‡­è¯æµ‹è¯•æˆåŠŸ", "success");
            updateAuthStatus("valid", "ç™»å½•å‡­è¯æœ‰æ•ˆ");
          } else {
            showNotification("ç™»å½•å‡­è¯æµ‹è¯•å¤±è´¥: " + data.message, "error");
            updateAuthStatus("invalid", "ç™»å½•å‡­è¯æ— æ•ˆ");
          }
        })
        .catch((error) => {
          showNotification("æµ‹è¯•å¤±è´¥: " + error.message, "error");
          updateAuthStatus("invalid", "ç™»å½•å‡­è¯æµ‹è¯•å¤±è´¥");
        });
    }

    function clearAuth() {
      localStorage.removeItem("xhs_cookie");
      document.getElementById("authInput").value = "";
      showNotification("ç™»å½•å‡­è¯å·²æ¸…é™¤", "info");
      checkAuthStatus();
    }

    function checkAuthStatus() {
      const auth = localStorage.getItem("xhs_cookie");
      if (auth) {
        updateAuthStatus("unknown", "ç™»å½•å‡­è¯å·²é…ç½®ï¼Œå»ºè®®æµ‹è¯•");
      } else {
        updateAuthStatus("unknown", "ç™»å½•å‡­è¯æœªé…ç½®");
      }
    }

    function updateAuthStatus(status, text) {
      const indicator = document.getElementById("statusIndicator");
      const statusText = document.getElementById("statusText");

      indicator.className = `status-indicator ${status}`;
      statusText.textContent = text;

      switch (status) {
        case "valid":
          indicator.textContent = "âœ…";
          break;
        case "invalid":
          indicator.textContent = "âŒ";
          break;
        default:
          indicator.textContent = "âš ï¸";
      }
    }

    function showNotification(message, type = "info") {
      // ç§»é™¤ç°æœ‰é€šçŸ¥
      const existing = document.querySelector(".notification");
      if (existing) {
        existing.remove();
      }

      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => notification.classList.add("show"), 100);

      // è‡ªåŠ¨éšè—
      setTimeout(() => {
        notification.classList.remove("show");
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function startSearch(keyword, numNotes) {
      const searchBtn = document.getElementById("searchBtn");
      const progressSection = document.getElementById("progressSection");

      searchBtn.disabled = true;
      searchBtn.textContent = "å¯åŠ¨ä¸­...";
      progressSection.style.display = "block";

      // è·å–Cookie
      const cookie = localStorage.getItem("xhs_cookie");

      fetch("/api/search", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          keyword: keyword,
          num_notes: numNotes,
          cookie: cookie,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            throw new Error(data.error);
          }

          currentTaskId = data.task_id;
          searchBtn.textContent = "é‡‡é›†ä¸­...";

          startProgressPolling();
        })
        .catch((error) => {
          console.error("Error:", error);
          showNotification("å¯åŠ¨å¤±è´¥: " + error.message, "error");
          resetSearchButton();
        });
    }

    function startProgressPolling() {
      progressInterval = setInterval(() => {
        if (currentTaskId) {
          checkTaskStatus(currentTaskId);
        }
      }, 2000);
    }

    function checkTaskStatus(taskId) {
      fetch(`/api/task/${taskId}/status`)
        .then((response) => response.json())
        .then((data) => {
          updateProgress(data);

          if (data.status === "completed") {
            clearInterval(progressInterval);
            onTaskCompleted(taskId);
          } else if (data.status === "failed") {
            clearInterval(progressInterval);
            onTaskFailed(data.error);
          }
        })
        .catch((error) => {
          console.error("Error checking status:", error);
        });
    }

    function updateProgress(data) {
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");

      progressFill.style.width = data.progress + "%";

      if (data.status === "running") {
        progressText.textContent = `è¿›åº¦ ${data.progress}%`;
      } else if (data.status === "pending") {
        progressText.textContent = "å‡†å¤‡ä¸­...";
      }
    }

    function onTaskCompleted(taskId) {
      const progressText = document.getElementById("progressText");
      progressText.textContent = "å®Œæˆ";

      showNotification("é‡‡é›†å®Œæˆï¼", "success");

      setTimeout(() => {
        resetSearchButton();
        loadTasks();
        window.open(`/view/${taskId}`, "_blank");
      }, 1000);
    }

    function onTaskFailed(error) {
      const progressText = document.getElementById("progressText");
      progressText.textContent = "å¤±è´¥: " + error;

      showNotification("é‡‡é›†å¤±è´¥: " + error, "error");

      setTimeout(() => {
        resetSearchButton();
      }, 3000);
    }

    function resetSearchButton() {
      const searchBtn = document.getElementById("searchBtn");
      const progressSection = document.getElementById("progressSection");

      searchBtn.disabled = false;
      searchBtn.textContent = "å¼€å§‹é‡‡é›†";
      progressSection.style.display = "none";

      currentTaskId = null;
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }

    function loadTasks() {
      fetch("/api/tasks")
        .then((response) => response.json())
        .then((tasks) => {
          displayTasks(tasks);
        })
        .catch((error) => {
          console.error("Error loading tasks:", error);
        });
    }

    function displayTasks(tasks) {
      const tasksList = document.getElementById("tasksList");

      if (tasks.length === 0) {
        tasksList.innerHTML = '<div class="empty-state">æš‚æ— è®°å½•</div>';
        return;
      }

      tasksList.innerHTML = tasks
        .map(
          (task) => `
                <div class="task-item">
                    <div class="task-info">
                        <h3>${task.keyword}</h3>
                        <p>${new Date(task.created_at).toLocaleString()}</p>
                    </div>
                    <div>
                        <span class="task-status status-${task.status}">
                            ${getStatusText(task.status)}
                        </span>
                        ${task.status === "completed"
              ? `<a href="/view/${task.id}" target="_blank" class="view-btn">æŸ¥çœ‹</a>`
              : ""
            }
                    </div>
                </div>
            `
        )
        .join("");
    }

    function getStatusText(status) {
      const statusMap = {
        pending: "ç­‰å¾…",
        running: "è¿›è¡Œä¸­",
        completed: "å®Œæˆ",
        failed: "å¤±è´¥",
      };
      return statusMap[status] || status;
    }
  </script>
</body>

</html>